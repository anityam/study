<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/study/favicon.ico"/><title>Service mesh</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Personal Knowledge Space"/><meta property="og:title" content="Service mesh"/><meta property="og:description" content="Personal Knowledge Space"/><meta property="og:url" content="https://anityam.github.io/study/notes/9w063ps0rewi5dfc5ryfnq6/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="7/30/2023"/><meta property="article:modified_time" content="8/6/2023"/><link rel="canonical" href="https://anityam.github.io/study/notes/9w063ps0rewi5dfc5ryfnq6/"/><meta name="next-head-count" content="14"/><link rel="preload" href="/study/_next/static/css/044c0a00d0460513.css" as="style"/><link rel="stylesheet" href="/study/_next/static/css/044c0a00d0460513.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/study/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/study/_next/static/chunks/webpack-5578b6fc6d41399f.js" defer=""></script><script src="/study/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/study/_next/static/chunks/main-344a030d8dbce66c.js" defer=""></script><script src="/study/_next/static/chunks/pages/_app-bcf96bb2aefa29fd.js" defer=""></script><script src="/study/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/study/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/study/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/study/_next/static/kLMra1Euy_8s9TW94naqx/_buildManifest.js" defer=""></script><script src="/study/_next/static/kLMra1Euy_8s9TW94naqx/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="service-mesh">Service mesh<a aria-hidden="true" class="anchor-heading icon-link" href="#service-mesh"></a></h1>
<h1 id="service-mesh-1">Service Mesh<a aria-hidden="true" class="anchor-heading icon-link" href="#service-mesh-1"></a></h1>
<p>The way to manage traffic inside the kubernetes cluster. The services in a fast pace microservice type environment where many applications are talking to each other, the requirements for the proxy( connection flows) for each application becomes to huge to manually manage.
Instead of injecting logic on each service or having many services for an application is cumbersome. Therefore a service mesh is an infrastructure that handles the data plane for all the services and controls the flow of traffic in a cluster. With  a service mesh the logic for traffic flow
can be a stand alone application without introducing the network logic in the application design. Istio is a open source service mesh popular in the company standard. </p>
<h2 id="istio">Istio<a aria-hidden="true" class="anchor-heading icon-link" href="#istio"></a></h2>
<h2 id="installation">Installation<a aria-hidden="true" class="anchor-heading icon-link" href="#installation"></a></h2>
<p>The installation of istio control plane is done at the <code>istio-system</code> namespace. The process for installation can be followed at <a href="https://github.com/anityam/istio">https://github.com/anityam/istio</a> . The installation will install the control plane at <code>istio-system</code>.</p>
<h2 id="component">Component<a aria-hidden="true" class="anchor-heading icon-link" href="#component"></a></h2>
<p>Istiod --> This is the main component of the control plane. The custom resources that istio uses like <code>virtualhost</code> are converted to envoy configs by istiod</p>
<h2 id="traffic-entry-point">Traffic Entry point<a aria-hidden="true" class="anchor-heading icon-link" href="#traffic-entry-point"></a></h2>
<p>The traffic in the istio cluster moves inside the cluster through the <strong>INGRESS</strong> resource.</p>
<h3 id="concept">Concept<a aria-hidden="true" class="anchor-heading icon-link" href="#concept"></a></h3>
<p>Istiod is the controller for the Ingress resource. It looks at the configs and configures the envoy based proxy. This can have a corresponding nodePort or external cloud based loadbalancer that exposes the traffic </p>
<h4 id="envoy-proxy">Envoy Proxy<a aria-hidden="true" class="anchor-heading icon-link" href="#envoy-proxy"></a></h4>
<h2 id="concept-1">Concept<a aria-hidden="true" class="anchor-heading icon-link" href="#concept-1"></a></h2>
<p>Istio keeps a database of it's managed service and service endpoints in a registry called service registry. The envoy proxy uses this service registry to route the traffic. Istio has a mechanism of service discovery (Pilot) or <a href="https://istio.io/latest/docs/reference/config/networking/service-entry/">ServiceEntry</a> configuration can be added to add the service to the service Registry.
Envoy proxy distributes traffic based on least load model. If there are more than two loadbalancer or host receiving the traffic than envoy routes the traffic to the host that is handling the least amount of traffic
Outside of the routes istio can also split traffic across instances </p>
<h2 id="apis">Apis<a aria-hidden="true" class="anchor-heading icon-link" href="#apis"></a></h2>
<ol>
<li>Virtual Service</li>
<li>Destination Rule</li>
<li>Service Entry</li>
<li>Gateways</li>
<li>Sidecars</li>
</ol>
<h3 id="ingress-gateway">Ingress Gateway<a aria-hidden="true" class="anchor-heading icon-link" href="#ingress-gateway"></a></h3>
<p>The entry point to the cluster. This is deployed in the <code>istio-system</code> namespace. This uses an Envoy proxy for the traffic coming from outside the cluster which is usually a loadbalancer(for external cloud based deployment) or a nodeport. We can use <code>istioctl</code> to inspect all the traffic flows that are being listed in the ingress gateway envoy filter. The process running inside the ingressgateway is the </p>
<pre class="language-bash"><code class="language-bash">k <span class="token builtin class-name">exec</span> -n istio-system deploy/istio-ingressgateway -- <span class="token function">ps</span>  
    PID TTY          TIME CMD
      <span class="token number">1</span> ?        00:00:04 pilot-agent
     <span class="token number">20</span> ?        00:00:21 envoy
     <span class="token number">39</span> ?        00:00:00 <span class="token function">ps</span>
</code></pre>
<p>The <code>pilot-agent</code> bootstraps the envoy filter and creates the rules which can be view by</p>
<pre class="language-bash"><code class="language-bash">istioctl -n istio-system proxy-config route deploy/istio-ingressgateway
NAME     VHOST NAME     DOMAINS     MATCH                  VIRTUAL SERVICE
         backend        *           /stats/prometheus*     
         backend        *           /healthz/ready*        
</code></pre>
<p>The next chapter is to open up the traffic flow inside the cluster</p>
<h3 id="gateway">Gateway<a aria-hidden="true" class="anchor-heading icon-link" href="#gateway"></a></h3>
<p>Gateway are how traffic comes to the cluster and then it can be routed to a virtual service. The gateway opens up a specific port on the ingress-gateway for incoming traffic. once a gateway is deploy </p>
<pre class="language-bash"><code class="language-bash">k get gateway
NAME                AGE
coolstore-gateway   63s
</code></pre>
<p>Now when we look at the envoy proxy-config we will see the port being opened </p>
<pre class="language-bash"><code class="language-bash">istioctl -n istio-system proxy-config route deploy/istio-ingressgateway
NAME          VHOST NAME         DOMAINS     MATCH                  VIRTUAL SERVICE
http.8080     blackhole:8080     *           /*                     <span class="token number">404</span>
              backend            *           /stats/prometheus*     
              backend            *           /healthz/ready* 
</code></pre>
<p><strong>blackhole</strong> is due to the absence of any routing to the upstream cluster. Therefore all the traffic is now passed to a blackhole of 404 so when you hit the endpoint <code>http://127.0.0.1:3000/</code> (port 3000 is due to the nodePort setup of istio-ingressgateway) we will see a 404</p>
<h3 id="virtual-service">Virtual Service<a aria-hidden="true" class="anchor-heading icon-link" href="#virtual-service"></a></h3>
<p>This routes the traffic from to specific services at the backend. It can be used to define routes to various real services based on the rules.In the VirtualService we will define the routes specified for the upstream traffic. Once the virtual service defines the traffic we can see the traffic routes in the proxy</p>
<pre class="language-bash"><code class="language-bash">istioctl -n istio-system proxy-config route deploy/istio-ingressgateway
NAME          VHOST NAME                       DOMAINS                     MATCH                  VIRTUAL SERVICE
http.8080     webapp.istioinaction.io:8080     webapp.istioinaction.io     /*                     webapp-vs-from-gw.istioinaction
              backend                          *                           /stats/prometheus*     
              backend                          *                           /healthz/ready* 
</code></pre>
<p>With the route set now the webpage can be viewed at <code>http://webapp.istioinaction.io:3000/</code> (here the <a href="http://weapp.istioinaction.io">http://weapp.istioinaction.io</a> is pointing to 127.0.0.1 at <code>/etc/hosts</code>). </p>
<h3 id="destination-rule">Destination Rule<a aria-hidden="true" class="anchor-heading icon-link" href="#destination-rule"></a></h3>
<p>This handles traffic to the specific destination. This is behind the virtual service once the traffic is directed to specific host then the destination service can apply the rules to the traffic</p>
<h3 id="service-entry">Service Entry<a aria-hidden="true" class="anchor-heading icon-link" href="#service-entry"></a></h3>
<p>This is usually used to define a traffic leaving a cluster where a specific call in the cluster can be routed to an entry point pointing to the external cluster.</p>
<h3 id="sidecars">sidecars<a aria-hidden="true" class="anchor-heading icon-link" href="#sidecars"></a></h3>
<p>To define a special rules for the sidecars used by the istio</p>
<h2 id="document">Document<a aria-hidden="true" class="anchor-heading icon-link" href="#document"></a></h2>
<p><a href="https://istio.io/latest/docs/concepts/traffic-management/">https://istio.io/latest/docs/concepts/traffic-management/</a> --> Traffic management read
<a href="https://banzaicloud.com/blog/backyards-ingress/">https://banzaicloud.com/blog/backyards-ingress/</a>  ---> Ingress Istio
<a href="https://istio.io/latest/docs/concepts/traffic-management/#virtual-services">https://istio.io/latest/docs/concepts/traffic-management/#virtual-services</a> --> Virtual Service</p>
<hr>
<strong>Children</strong>
<ol>
<li><a href="/study/notes/1x0zf84gbbfnd1owvoeciml">Envoy</a></li>
</ol></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#service-mesh" title="Service Mesh">Service Mesh</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#istio" title="Istio">Istio</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#installation" title="Installation">Installation</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#component" title="Component">Component</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#traffic-entry-point" title="Traffic Entry point">Traffic Entry point</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#concept" title="Concept">Concept</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#envoy-proxy" title="Envoy Proxy">Envoy Proxy</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#concept-1" title="Concept">Concept</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#apis" title="Apis">Apis</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#ingress-gateway" title="Ingress Gateway">Ingress Gateway</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#gateway" title="Gateway">Gateway</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#virtual-service" title="Virtual Service">Virtual Service</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#destination-rule" title="Destination Rule">Destination Rule</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#service-entry" title="Service Entry">Service Entry</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#sidecars" title="sidecars">sidecars</a></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#document" title="Document">Document</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"9w063ps0rewi5dfc5ryfnq6","title":"Service mesh","desc":"","updated":1691355996455,"created":1690718362197,"custom":{},"fname":"Container.kubernetes.Service mesh","type":"note","vault":{"fsPath":".","selfContained":true,"name":"Dendron"},"contentHash":"4b8dc737e98e98ccf4ef35dec4c4ac16","links":[],"anchors":{"service-mesh":{"type":"header","text":"Service Mesh","value":"service-mesh","line":7,"column":0,"depth":1},"istio":{"type":"header","text":"Istio","value":"istio","line":12,"column":0,"depth":2},"installation":{"type":"header","text":"Installation","value":"installation","line":13,"column":0,"depth":2},"component":{"type":"header","text":"Component","value":"component","line":16,"column":0,"depth":2},"traffic-entry-point":{"type":"header","text":"Traffic Entry point","value":"traffic-entry-point","line":19,"column":0,"depth":2},"concept":{"type":"header","text":"Concept","value":"concept","line":21,"column":0,"depth":3},"envoy-proxy":{"type":"header","text":"Envoy Proxy","value":"envoy-proxy","line":24,"column":0,"depth":4},"concept-1":{"type":"header","text":"Concept","value":"concept-1","line":27,"column":0,"depth":2},"apis":{"type":"header","text":"Apis","value":"apis","line":32,"column":0,"depth":2},"ingress-gateway":{"type":"header","text":"Ingress Gateway","value":"ingress-gateway","line":39,"column":0,"depth":3},"gateway":{"type":"header","text":"Gateway","value":"gateway","line":58,"column":0,"depth":3},"virtual-service":{"type":"header","text":"Virtual Service","value":"virtual-service","line":77,"column":0,"depth":3},"destination-rule":{"type":"header","text":"Destination Rule","value":"destination-rule","line":88,"column":0,"depth":3},"service-entry":{"type":"header","text":"Service Entry","value":"service-entry","line":92,"column":0,"depth":3},"sidecars":{"type":"header","text":"sidecars","value":"sidecars","line":95,"column":0,"depth":3},"document":{"type":"header","text":"Document","value":"document","line":104,"column":0,"depth":2}},"children":["1x0zf84gbbfnd1owvoeciml"],"parent":"e0m1k0omc4yj2zlohg0n2wy","data":{}},"body":"\u003ch1 id=\"service-mesh\"\u003eService mesh\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#service-mesh\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003ch1 id=\"service-mesh-1\"\u003eService Mesh\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#service-mesh-1\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003eThe way to manage traffic inside the kubernetes cluster. The services in a fast pace microservice type environment where many applications are talking to each other, the requirements for the proxy( connection flows) for each application becomes to huge to manually manage.\nInstead of injecting logic on each service or having many services for an application is cumbersome. Therefore a service mesh is an infrastructure that handles the data plane for all the services and controls the flow of traffic in a cluster. With  a service mesh the logic for traffic flow\ncan be a stand alone application without introducing the network logic in the application design. Istio is a open source service mesh popular in the company standard. \u003c/p\u003e\n\u003ch2 id=\"istio\"\u003eIstio\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#istio\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003ch2 id=\"installation\"\u003eInstallation\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#installation\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe installation of istio control plane is done at the \u003ccode\u003eistio-system\u003c/code\u003e namespace. The process for installation can be followed at \u003ca href=\"https://github.com/anityam/istio\"\u003ehttps://github.com/anityam/istio\u003c/a\u003e . The installation will install the control plane at \u003ccode\u003eistio-system\u003c/code\u003e.\u003c/p\u003e\n\u003ch2 id=\"component\"\u003eComponent\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#component\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eIstiod --\u003e This is the main component of the control plane. The custom resources that istio uses like \u003ccode\u003evirtualhost\u003c/code\u003e are converted to envoy configs by istiod\u003c/p\u003e\n\u003ch2 id=\"traffic-entry-point\"\u003eTraffic Entry point\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#traffic-entry-point\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eThe traffic in the istio cluster moves inside the cluster through the \u003cstrong\u003eINGRESS\u003c/strong\u003e resource.\u003c/p\u003e\n\u003ch3 id=\"concept\"\u003eConcept\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#concept\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eIstiod is the controller for the Ingress resource. It looks at the configs and configures the envoy based proxy. This can have a corresponding nodePort or external cloud based loadbalancer that exposes the traffic \u003c/p\u003e\n\u003ch4 id=\"envoy-proxy\"\u003eEnvoy Proxy\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#envoy-proxy\"\u003e\u003c/a\u003e\u003c/h4\u003e\n\u003ch2 id=\"concept-1\"\u003eConcept\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#concept-1\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003eIstio keeps a database of it's managed service and service endpoints in a registry called service registry. The envoy proxy uses this service registry to route the traffic. Istio has a mechanism of service discovery (Pilot) or \u003ca href=\"https://istio.io/latest/docs/reference/config/networking/service-entry/\"\u003eServiceEntry\u003c/a\u003e configuration can be added to add the service to the service Registry.\nEnvoy proxy distributes traffic based on least load model. If there are more than two loadbalancer or host receiving the traffic than envoy routes the traffic to the host that is handling the least amount of traffic\nOutside of the routes istio can also split traffic across instances \u003c/p\u003e\n\u003ch2 id=\"apis\"\u003eApis\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#apis\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003col\u003e\n\u003cli\u003eVirtual Service\u003c/li\u003e\n\u003cli\u003eDestination Rule\u003c/li\u003e\n\u003cli\u003eService Entry\u003c/li\u003e\n\u003cli\u003eGateways\u003c/li\u003e\n\u003cli\u003eSidecars\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"ingress-gateway\"\u003eIngress Gateway\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#ingress-gateway\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThe entry point to the cluster. This is deployed in the \u003ccode\u003eistio-system\u003c/code\u003e namespace. This uses an Envoy proxy for the traffic coming from outside the cluster which is usually a loadbalancer(for external cloud based deployment) or a nodeport. We can use \u003ccode\u003eistioctl\u003c/code\u003e to inspect all the traffic flows that are being listed in the ingress gateway envoy filter. The process running inside the ingressgateway is the \u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ek \u003cspan class=\"token builtin class-name\"\u003eexec\u003c/span\u003e -n istio-system deploy/istio-ingressgateway -- \u003cspan class=\"token function\"\u003eps\u003c/span\u003e  \n    PID TTY          TIME CMD\n      \u003cspan class=\"token number\"\u003e1\u003c/span\u003e ?        00:00:04 pilot-agent\n     \u003cspan class=\"token number\"\u003e20\u003c/span\u003e ?        00:00:21 envoy\n     \u003cspan class=\"token number\"\u003e39\u003c/span\u003e ?        00:00:00 \u003cspan class=\"token function\"\u003eps\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003ccode\u003epilot-agent\u003c/code\u003e bootstraps the envoy filter and creates the rules which can be view by\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eistioctl -n istio-system proxy-config route deploy/istio-ingressgateway\nNAME     VHOST NAME     DOMAINS     MATCH                  VIRTUAL SERVICE\n         backend        *           /stats/prometheus*     \n         backend        *           /healthz/ready*        \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe next chapter is to open up the traffic flow inside the cluster\u003c/p\u003e\n\u003ch3 id=\"gateway\"\u003eGateway\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#gateway\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eGateway are how traffic comes to the cluster and then it can be routed to a virtual service. The gateway opens up a specific port on the ingress-gateway for incoming traffic. once a gateway is deploy \u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003ek get gateway\nNAME                AGE\ncoolstore-gateway   63s\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow when we look at the envoy proxy-config we will see the port being opened \u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eistioctl -n istio-system proxy-config route deploy/istio-ingressgateway\nNAME          VHOST NAME         DOMAINS     MATCH                  VIRTUAL SERVICE\nhttp.8080     blackhole:8080     *           /*                     \u003cspan class=\"token number\"\u003e404\u003c/span\u003e\n              backend            *           /stats/prometheus*     \n              backend            *           /healthz/ready* \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eblackhole\u003c/strong\u003e is due to the absence of any routing to the upstream cluster. Therefore all the traffic is now passed to a blackhole of 404 so when you hit the endpoint \u003ccode\u003ehttp://127.0.0.1:3000/\u003c/code\u003e (port 3000 is due to the nodePort setup of istio-ingressgateway) we will see a 404\u003c/p\u003e\n\u003ch3 id=\"virtual-service\"\u003eVirtual Service\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#virtual-service\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThis routes the traffic from to specific services at the backend. It can be used to define routes to various real services based on the rules.In the VirtualService we will define the routes specified for the upstream traffic. Once the virtual service defines the traffic we can see the traffic routes in the proxy\u003c/p\u003e\n\u003cpre class=\"language-bash\"\u003e\u003ccode class=\"language-bash\"\u003eistioctl -n istio-system proxy-config route deploy/istio-ingressgateway\nNAME          VHOST NAME                       DOMAINS                     MATCH                  VIRTUAL SERVICE\nhttp.8080     webapp.istioinaction.io:8080     webapp.istioinaction.io     /*                     webapp-vs-from-gw.istioinaction\n              backend                          *                           /stats/prometheus*     \n              backend                          *                           /healthz/ready* \n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWith the route set now the webpage can be viewed at \u003ccode\u003ehttp://webapp.istioinaction.io:3000/\u003c/code\u003e (here the \u003ca href=\"http://weapp.istioinaction.io\"\u003ehttp://weapp.istioinaction.io\u003c/a\u003e is pointing to 127.0.0.1 at \u003ccode\u003e/etc/hosts\u003c/code\u003e). \u003c/p\u003e\n\u003ch3 id=\"destination-rule\"\u003eDestination Rule\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#destination-rule\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThis handles traffic to the specific destination. This is behind the virtual service once the traffic is directed to specific host then the destination service can apply the rules to the traffic\u003c/p\u003e\n\u003ch3 id=\"service-entry\"\u003eService Entry\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#service-entry\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThis is usually used to define a traffic leaving a cluster where a specific call in the cluster can be routed to an entry point pointing to the external cluster.\u003c/p\u003e\n\u003ch3 id=\"sidecars\"\u003esidecars\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#sidecars\"\u003e\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eTo define a special rules for the sidecars used by the istio\u003c/p\u003e\n\u003ch2 id=\"document\"\u003eDocument\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#document\"\u003e\u003c/a\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://istio.io/latest/docs/concepts/traffic-management/\"\u003ehttps://istio.io/latest/docs/concepts/traffic-management/\u003c/a\u003e --\u003e Traffic management read\n\u003ca href=\"https://banzaicloud.com/blog/backyards-ingress/\"\u003ehttps://banzaicloud.com/blog/backyards-ingress/\u003c/a\u003e  ---\u003e Ingress Istio\n\u003ca href=\"https://istio.io/latest/docs/concepts/traffic-management/#virtual-services\"\u003ehttps://istio.io/latest/docs/concepts/traffic-management/#virtual-services\u003c/a\u003e --\u003e Virtual Service\u003c/p\u003e\n\u003chr\u003e\n\u003cstrong\u003eChildren\u003c/strong\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"/study/notes/1x0zf84gbbfnd1owvoeciml\"\u003eEnvoy\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e","noteIndex":{"id":"root","title":"root","desc":"","updated":1705329732869,"created":1595961348801,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":".","selfContained":true,"name":"Dendron"},"contentHash":"1dc37f517d4ed7428cb6cd839465a28a","links":[],"anchors":{},"children":["jb6glaqzhtlu81fjsdvclge","dgp0079geib2iw0p2lmhm1j","kvfgz9sv96p3uqosotptdgk"],"parent":null,"data":{},"body":"This is learning journal. The intend is to document concepts.\n`---`.\n"},"collectionChildren":null,"customHeadContent":null,"config":{"version":5,"dev":{"enablePreviewV2":true,"enableSelfContainedVaults":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":false,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"vaults":[{"fsPath":"dependencies/localhost/Herauna","selfContained":true,"name":"Herauna"},{"fsPath":".","selfContained":true,"name":"Dendron"}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"task","dateFormat":"y.MM.dd","addBehavior":"asOwnDomain","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"taskCompleteStatus":["done","x"],"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link"},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":true,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800,"enableFullHierarchyNoteTitle":false},"preview":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false},"publishing":{"enableFMTitle":true,"enableNoteTitleForLink":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"Dendron","description":"Personal Knowledge Space"},"github":{"enableEditLink":true,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enableTaskNotes":true,"enablePrettyLinks":true,"searchMode":"search","assetsPrefix":"/study","siteUrl":"https://anityam.github.io","duplicateNoteBehavior":{"action":"useVault","payload":["Herauna","Dendron"]},"siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"9w063ps0rewi5dfc5ryfnq6"},"buildId":"kLMra1Euy_8s9TW94naqx","assetPrefix":"/study","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>